<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="pragma" content="no-cache">
		<meta name="renderer" content="ie-comp">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />

		<title></title>
		
		<link rel="stylesheet" type="text/css" href="css/mui/mui.min.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header" >
			<button style="line-height: 48px;" type="button" class="mui-left mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left">
				<span class="mui-icon mui-icon-left-nav"></span>返回
			</button>
			<h1 class="mui-title">注册</h1>
			<button style="line-height: 48px;" id="get_code" type="button" class="mui-right  mui-btn mui-btn-link mui-btn-nav mui-pull-right">
				获取验证码
			</button>
		</header>
		<div class="mui-content" style="margin-top:20px;">
			<form class="mui-input-group">
				<div class="mui-input-row">
					<label>账号</label>
					<input id="username" type="text" value="" placeholder="请输入账号 (不少于6位的大小写字母组合)" class="mui-input-clear" />
				</div>
				<div class="mui-input-row">
					<label>密码</label>
					<input id="password" type="password" value="" placeholder="请输入密码 (不少于6位)" class="mui-input-clear" />
				</div>
				<div class="mui-input-row">
					<label>手机号码</label>
					<input id="phone" type="text" value="" placeholder="请输入手机号码" class="mui-input-clear" />
				</div>
				<div class="mui-input-row">
					<label>验证码</label>
					<input id="code" type="text" value="" placeholder="请输入验证码" class="mui-input-clear" />
				</div>
			</form>
		</div>
		<div class="mui-content-padded" align="center" style="margin-top:20px;">

			<button id="region" class="mui-btn mui-btn-block mui-btn-primary">注册</button>

		</div>

		<script src="js/mui/mui.min.lee.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/My_Js/API.js" type="text/javascript" charset="utf-8"></script>
	</body>

	<script type="text/javascript">
		//╠═╬═╬═╬═╬═╬═╬═╬═╬═╬═╣  公共变量   ╠═╬═╬═╬═╬═╬═╬═╬═╬═╬═╣
		var obj_region = document.getElementById("region"); //注册按钮
		var obj_username = document.getElementById("username"); //账号
		var obj_password = document.getElementById("password"); //密码
		var obj_phone = document.getElementById("phone"); //手机号码
		var obj_code = document.getElementById("code"); //验证码
		var obj_get_code = document.getElementById("get_code");
		var guid = ""; //验证码专用guid
		var lock = false; //防止重复注册,false表示没锁 
		var code_lock = false; //防止重复申请验证码,false表示没锁 
		var VerCode = ""; //返回的验证码
		var Is_get_code = false; //是否已获取验证码
		
		//获取验证码
		get_code.addEventListener("tap", function() 
		{
			//防止重复申请验证码
			if(code_lock)
			{				
				return false;
			}
			//获取手机号码
			var phone = obj_phone.value;
			//判断是否为空
			if (phone.length == 0) {
				mui.toast("请先输入手机号码,再获取验证码");
				return;
			}
			//验证手机号码合法性
			if (!/^(13[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/i.test(phone)) {
				mui.toast('请先输入合法的手机号码,再获取验证码');
				return;
			}
			//生成验证码专用guid,存储全局变量中
			guid = newGuid();
			//为了安全起见，将验证码放入缓存中
			localStorage.setItem("guid", guid);			
			//开启倒计时,并且加锁、只有30秒过后才能解锁
			 showtime(30);							
			//调用接口
			InvokeApi(GetApiUrl("Global_V0001_5un29"), "G001_CustomerRegister", "GetVerCode", {
				"验证码请求号": guid,
				"手机号码": phone
			}, "CYAPI_获取验证码");
		})
		//注册
		region.addEventListener('tap', function() 
		{					
			//判断锁，防止重复提交			
			if(lock == true) return false;					
									
			//取值
			var username = obj_username.value;
			var password = obj_password.value;
			var phone = obj_phone.value;
			var code = obj_get_code.value;
						
			
			if (username.length == 0) 
			{
				mui.toast("您的账号不可为空！");
				//obj_username.focus();
				return;
			} 			
			if (!/[_a-zA-Z]+\d+/g.test(username) && username.length < 6)
			{
				mui.toast("请输入以字母和数字组合6位以上的账号");
				//obj_username.focus(); //聚焦
				return;
			}			
			if (password.length == 0) 
			{
				mui.toast("您的密码不可为空!");
				//obj_password.focus();//聚焦
				return;
			}
			if (password.length < 6) 
			{
				mui.toast("请输入不少于6位的密码");
				//obj_password.focus();//聚焦
				return;
			}
			if (phone.length == 0) 
			{
				mui.toast("您的手机号码不可为空！");
				//obj_phone.focus();
				return;
			}		
			if (!/^(13[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/i.test(phone)) 
			{
				mui.toast('请输入合法的手机号码');
				//obj_phone.focus();
				return;
			}
			if (code.length == 0) 
			{
				mui.toast("请输入验证码，你可以通过点击右上角【获取验证码】取得");
				//obj_code.focus();
				return;
			}
			
			//加上锁，因为接下来的验证是要发送到服务器的
			lock = true;
			
			//加入提示,因为接下来的操作可能会比较耗时间
			obj_region.innerHTML = "请稍后...";
			
			//验证账号
			InvokeApi(GetApiUrl("Global_V0001_5un29"), "G001_CustomerRegister", "CheckLoginName", {
				"登录名": username
			}, "CYAPI_检验登陆名")
			
			
			//检验验证码
			InvokeApi(GetApiUrl("Global_V0001_5un29"), "G001_CustomerRegister", "CheckVerCode", {
				"登录账号": username,
				"密码": password
			}, "CYAPI_获取返回值");			
			
		})
		//╠═╬═╬═╬═╬═╬═╬═╬═╬═╬═╣  方法体  ╠═╬═╬═╬═╬═╬═╬═╬═╬═╬═╣
		function newGuid() {
			var guid = "";
			for (var i = 1; i <= 32; i++) {
				var n = Math.floor(Math.random() * 16.0).toString(16);
				guid += n;
				if ((i == 8) || (i == 12) || (i == 16) || (i == 20))
					guid += "-";
			}
			return guid.replace(/-/g, "");
		}
		
		function mySetInterval()
		{
			code_lock = true; //加锁		    
		    obj_get_code.style.color = "#a9a9a9"; //颜色改变
			var t = 30;
			var myInterval =  setInterval(function()
			{
				obj_get_code.innerText = " (" + t +")秒后重新发送"; 
				t--;
				if(t <= 0)
				{
					clearInterval(myInterval);
					obj_get_code.innerText ="获取验证码"; 
			      	code_lock = false; //解锁
			      	obj_get_code.style.color = "#007aff"; //颜色改变
				}
			},1000);
		}
		
		function showtime(t)
		{			
		    code_lock = true; //加锁		    
		    obj_get_code.style.color = "#a9a9a9"; //颜色改变
		    
		    for(i = 1; i <= t; i++)
		    {
		    	if(Is_get_code)
		    	{
		    		return false; //如果已经获取验证码，那么暂停倒计时
		    	}
		    	
		        window.setTimeout("update_p(" + i + ","+t+")", i * 1000); 
		    } 		 
		} 
		 
		function update_p(num,t) 
		{
		    if(num == t) 
		    {
		        obj_get_code.innerText ="获取验证码"; 
		      	code_lock = false; //解锁
		      	obj_get_code.style.color = "#007aff"; //颜色改变
		    } 
		    else { 
		        printnr = t-num; 
		        obj_get_code.innerText = " (" + printnr +")秒后重新发送"; 
		    } 
		} 
		//╠═╬═╬═╬═╬═╬═╬═╬═╬═╬═╣  以下是API接收区 ╠═╬═╬═╬═╬═╬═╬═╬═╬═╬═╣
		CYAPI_注册用户 = function(str) {
			alert(str);
			var jsonobj = Api_filter(str);
		}
		CYAPI_检验登陆名 = function(str) {
			alert(str);
			var jsonobj = Api_filter(str);
		}
		CYAPI_获取验证码 = function(str) {
			
			var jsonobj = Api_filter(str);
			
			var ResCode = jsonobj.ResCode; //状态
			var ResMsg = jsonobj.ResMsg;   //信息
			var _VerCode = jsonobj.VerCode; //验证码
			
			if(ResCode == "1")
			{				
				Is_get_code = true; //标志已获取验证码
				localStorage.setItem("VerCode",_VerCode); //放入缓存中
				VerCode = _VerCode; //放入全局变量中
				obj_get_code.innerHTML = "验证码： " + VerCode; //将验证码展示给用户观看
			}
			
			mui.toast(ResMsg);	
			
		}
		CYAPI_检验验证码 = function(str) 
		{
			alert(str);
			var jsonobj = Api_filter(str);
		}
	</script>

</html>